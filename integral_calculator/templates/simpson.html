{% extends "base.html" %}
{% block title %}Metode Simpson 1/3 - Kalkulator Integral Numerik{% endblock %}
{% block content %}
<div class="row fade-in">
    <div class="col-12">
        <div class="card mb-4">
            <div class="card-header bg-success text-white">
                <h2 class="mb-0"><i class="fas fa-chart-line"></i> Metode Simpson 1/3</h2>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <p class="lead">Metode Simpson 1/3 membagi area di bawah kurva menjadi irisan parabola.</p>
                        <div class="alert alert-info">
                            <h6><i class="fas fa-info-circle"></i> Formula Metode Simpson 1/3:</h6>
                            <div class="text-center my-3">
                                $$\int_a^b f(x)dx \approx \frac{h}{3}[f(x_0) + 4\sum_{i=1,3,\dots}^{n-1}f(x_i) + 2\sum_{i=2,4,\dots}^{n-2}f(x_i) + f(x_n)]$$
                            </div>
                            <p class="mb-0">dimana $h = \frac{b-a}{n}$ dan n harus genap</p>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="alert alert-warning">
                            <h6><i class="fas fa-lightbulb"></i> Tips:</h6>
                            <ul class="mb-0 small">
                                <li>Gunakan nilai n genap</li>
                                <li>Contoh fungsi: x**3 + cos(x)</li>
                                <li>Pastikan f(x) terdefinisi di seluruh [a,b]</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-cogs"></i> Input Parameter</h5>
            </div>
            <div class="card-body">
                <form id="simpsonForm">
                    <div class="mb-3">
                        <label for="function" class="form-label">Fungsi f(x)</label>
                        <input type="text" class="form-control" id="function" value="x**2" required>
                        <small class="form-text text-muted">Gunakan x sebagai variabel, ** untuk pangkat</small>
                    </div>
                    <div class="row">
                        <div class="col-6">
                            <label for="lower_bound" class="form-label">Batas Bawah (a)</label>
                            <input type="number" class="form-control" id="lower_bound" value="0" step="any" required>
                        </div>
                        <div class="col-6">
                            <label for="upper_bound" class="form-label">Batas Atas (b)</label>
                            <input type="number" class="form-control" id="upper_bound" value="2" step="any" required>
                        </div>
                    </div>
                    <div class="mt-3 mb-3">
                        <label for="n_intervals" class="form-label">Jumlah Interval (n)</label>
                        <input type="number" class="form-control" id="n_intervals" value="10" min="2" step="2" required>
                        <small class="form-text text-muted">Harus bilangan genap</small>
                    </div>
                    <button type="submit" class="btn btn-success w-100">
                        <i class="fas fa-calculator"></i> Hitung Integral
                        <span class="loading spinner-border spinner-border-sm ms-2" role="status"></span>
                    </button>
                </form>
                <div class="mt-3">
                    <button class="btn btn-outline-secondary btn-sm w-100" onclick="loadExample()">
                        <i class="fas fa-lightbulb"></i> Muat Contoh
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-8">
        <div id="resultCard" class="card result-card d-none mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-chart-line"></i> Hasil Perhitungan</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-4">
                        <h6>Hasil Simpson</h6>
                        <h4 id="simpsonResult">-</h4>
                    </div>
                    <div class="col-md-4">
                        <h6>Hasil Analitik</h6>
                        <h4 id="analyticalResult">-</h4>
                    </div>
                    <div class="col-md-4">
                        <h6>Galat Relatif</h6>
                        <h4 id="relativeError">-</h4>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <small><strong>Galat Absolut:</strong> <span id="absoluteError">-</span></small>
                    </div>
                    <div class="col-md-6">
                        <small><strong>Jumlah Interval:</strong> <span id="intervals">-</span></small>
                    </div>
                </div>
            </div>
        </div>

        <div id="errorCard" class="card error-card d-none mb-4">
            <div class="card-body">
                <h5><i class="fas fa-exclamation-triangle"></i> Error</h5>
                <p id="errorMessage" class="mb-0"></p>
            </div>
        </div>

        <div class="card">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-chart-area"></i> Visualisasi Grafik</h5>
            </div>
            <div class="card-body">
                <canvas id="simpsonChart"></canvas>
                <div class="text-center mt-3">
                    <small class="text-muted"><i class="fas fa-info-circle"></i> Kurva biru: fungsi asli, area hijau: hasil pendekatan Simpson</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tabel Iterasi -->
<div class="card mb-4">
    <div class="card-header bg-light">
        <h5 class="mb-0"><i class="fas fa-table"></i> Tabel Iterasi</h5>
    </div>
    <div class="card-body table-responsive">
        <table class="table table-bordered table-striped small">
            <thead class="table-light">
                <tr>
                    <th>#</th>
                    <th>x<sub>i</sub></th>
                    <th>f(x<sub>i</sub>)</th>
                    <th>Koefisien</th>
                </tr>
            </thead>
            <tbody id="iterationTableBody">
                <!-- Diisi lewat JavaScript -->
            </tbody>
        </table>
    </div>
</div>


<script>
let simpsonChart = null;

document.getElementById('simpsonForm').addEventListener('submit', function(e) {
    e.preventDefault();
    calculateSimpson();
});

function loadExample() {
    document.getElementById('function').value = 'x**2 + sin(x)';
    document.getElementById('lower_bound').value = '0';
    document.getElementById('upper_bound').value = '3';
    document.getElementById('n_intervals').value = '10';
}

async function calculateSimpson() {
    const form = document.getElementById('simpsonForm');
    const loading = form.querySelector('.loading');
    const button = form.querySelector('button[type="submit"]');
    loading.classList.add('show');
    button.disabled = true;
    document.getElementById('resultCard').classList.add('d-none');
    document.getElementById('errorCard').classList.add('d-none');

    try {
        const data = {
            function: document.getElementById('function').value,
            lower_bound: parseFloat(document.getElementById('lower_bound').value),
            upper_bound: parseFloat(document.getElementById('upper_bound').value),
            n_intervals: parseInt(document.getElementById('n_intervals').value)
        };

        const response = await fetch('/calculate_simpson', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.error) {
            showError(result.error);
        } else {
            showResults(result);
            drawChart(result, data);
        }

    } catch (error) {
        showError('Terjadi kesalahan: ' + error.message);
    } finally {
        loading.classList.remove('show');
        button.disabled = false;
    }
}

function showResults(result) {
    document.getElementById('simpsonResult').textContent = result.simpson_result.toFixed(6);
    document.getElementById('analyticalResult').textContent =
        result.analytical_result ? result.analytical_result.toFixed(6) : 'N/A';

    if (result.analytical_result) {
        const absErr = Math.abs(result.simpson_result - result.analytical_result);
        const relErr = (absErr / Math.abs(result.analytical_result)) * 100;
        document.getElementById('absoluteError').textContent = absErr.toExponential(3);
        document.getElementById('relativeError').textContent = relErr.toFixed(4) + '%';
    } else {
        document.getElementById('absoluteError').textContent = 'N/A';
        document.getElementById('relativeError').textContent = 'N/A';
    }

    document.getElementById('intervals').textContent = document.getElementById('n_intervals').value;
    document.getElementById('resultCard').classList.remove('d-none');

    const tableBody = document.getElementById('iterationTableBody');
    tableBody.innerHTML = '';
    result.iteration_table.forEach(row => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${row.index}</td>
            <td>${row.x.toFixed(4)}</td>
            <td>${row.fx.toFixed(6)}</td>
            <td>${row.coef}</td>
        `;
        tableBody.appendChild(tr);
    });

}

function showError(message) {
    document.getElementById('errorMessage').textContent = message;
    document.getElementById('errorCard').classList.remove('d-none');
}

function drawChart(result, inputData) {
    const ctx = document.getElementById('simpsonChart').getContext('2d');
    if (simpsonChart) simpsonChart.destroy();

    const smooth = result.x_values.map((x, i) => ({x, y: result.y_values[i]}));
    const simpsonData = inputData.n_intervals + 1;
    const step = (inputData.upper_bound - inputData.lower_bound) / inputData.n_intervals;

    const approxPoints = [];
    for (let i = 0; i < simpsonData - 2; i += 2) {
        const x0 = inputData.lower_bound + i * step;
        const x1 = x0 + step;
        const x2 = x0 + 2 * step;
        approxPoints.push({x: x0, y: result.simpson_points[i]});
        approxPoints.push({x: x1, y: result.simpson_points[i + 1]});
        approxPoints.push({x: x2, y: result.simpson_points[i + 2]});
    }

    simpsonChart = new Chart(ctx, {
        type: 'line',
        data: {
            datasets: [
                {
                    label: 'Fungsi f(x)',
                    data: smooth,
                    borderColor: 'rgb(75, 192, 192)',
                    borderWidth: 3,
                    fill: false,
                    pointRadius: 0,
                    tension: 0.2
                },
                {
                    label: 'Approximasi Simpson',
                    data: approxPoints,
                    borderColor: 'rgba(255, 99, 132, 1)',
                    backgroundColor: 'rgba(255, 99, 132, 0.3)',
                    fill: true,
                    pointRadius: 3,
                    tension: 0.2
                }
            ]
        },
        options: {
            responsive: true,
            plugins: {
                title: {
                    display: true,
                    text: `Integral dari ${inputData.function} pada interval [${inputData.lower_bound}, ${inputData.upper_bound}]`,
                    font: { size: 16 }
                }
            },
            scales: {
                x: { type: 'linear', title: { display: true, text: 'x' } },
                y: { title: { display: true, text: 'f(x)' } }
            }
        }
    });
}
</script>
{% endblock %}
